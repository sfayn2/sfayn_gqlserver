name: CI | AWS Infra (LocalStack) & DDD Business Domain Validation
# This workflow sets up LocalStack, deploys AWS infrastructure using Terraform,
# and runs domain-specific tests to validate business logic in an AWS-like environment.
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger'

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Global Environment Variables for CI
    env:
      PYTHONPATH: "." 
      # AWS/LocalStack config
      AWS_ENDPOINT_URL: "http://localhost:4566"
      AWS_ACCESS_KEY_ID: "test"
      AWS_SECRET_ACCESS_KEY: "test"
      AWS_DEFAULT_REGION: "us-east-1"
      DYNAMODB_TABLE_NAME: "tntoms-tst-main-table"


      ORDER_MANAGEMENT_INFRA_TYPE: "AWS"
      SKIP_JWT_VERIFY: "true"  # Set to "true" to skip JWT verification in tests

      # Dynamically set the absolute paths using $GITHUB_WORKSPACE
      TF_VAR_lambda_function_s3_key_hot_reload: "${{ github.workspace }}"
      TF_VAR_lambda_function_s3_key_hot_reload_packages: "${{ github.workspace }}/.venv/lib/python3.14/site-packages/"
      TF_VAR_skip_jwt_verify: "true"  # Pass to Terraform variable
      TF_VAR_architectures: '["x86_64"]'


    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
    
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3" # Specify your version
          terraform_wrapper: false   # Recommended for tflocal


      - name: Set up and Start LocalStack
        working-directory: ./deploy/aws_localstack/
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up localstack -d --wait

      - name: Spin up AWS Infra with Terraform
        # Run this from your Terraform directory
        working-directory: ./deploy/aws_localstack/ 
        run: |
          # 1. Initialize Terraform (using tflocal wrapper)
          uv run tflocal init
          
          # 2. Apply configuration without manual approval
          uv run tflocal apply --auto-approve

      - name: Set up Python & Install Dependencies
        run: |
          cd ${{ github.workspace }}
          uv python install
          uv sync --all-extras --dev

      - name: Verify site-packages
        run: ls -d ${{ github.workspace }}/.venv/lib/python3.14/site-packages/

      - name: Run Pytest via AWS Shell Script
        run: |
          # curl -s http://localhost:4566/_localstack/health | jq
          uv run pytest "./ddd/order_management/tests/e2e/" -p no:django
          # uv run awslocal lambda invoke --function-name tntoms-tst-graphql-api out
          uv run pytest "./ddd/order_management/tests/full_e2e/test_add_order_full_e2e.py" -p no:django

      # 4. Cleanup (Good practice for CI runners)
      - name: Stop Infrastructure
        if: always()
        working-directory: ./deploy/aws_localstack/
        run: |
          uv run tflocal destroy --auto-approve
          # docker logs localstack_main
          docker compose down
